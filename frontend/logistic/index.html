<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistic - Staff Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <!-- Layout Wrapper -->
    <div id="layout">
        <!-- Konten Utama -->
        <div class="container py-4">
            <h2 class="mb-4">Manajemen Logistik</h2>

            <!-- Filter Status Pengiriman -->
            <div class="mb-3">
                <label for="filterStatus" class="form-label">Filter Status:</label>
                <select id="filterStatus" class="form-select" onchange="fetchShipments()">
                    <option value="">Semua</option>
                    <option value="pending">Belum Dikirim</option>
                    <option value="shipped">Sudah Dikirim</option>
                    <option value="delivered">Terkirim</option>
                </select>
            </div>

            <!-- Tabel Data Pengiriman -->
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Order ID</th>
                            <th>Alamat</th>
                            <th>Jasa</th>
                            <th>Berat (kg)</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="shipmentTableBody">
                        <tr><td colspan="7" class="text-center">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Form Kirim Barang -->
            <h4 class="mt-5">Form Kirim Barang</h4>
            <form onsubmit="submitShipment(event)" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">QC ID</label>
                    <input type="number" id="qc_id" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Order ID</label>
                    <input type="number" id="order_id" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Alamat Pengiriman</label>
                    <input type="text" id="shipping_address" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Jasa Pengiriman</label>
                    <input type="text" id="shipping_service" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Berat Barang (kg)</label>
                    <input type="number" id="weight" step="0.01" class="form-control" required>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Kirim</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5002/api/shipments';

        async function fetchShipments() {
            const status = document.getElementById('filterStatus').value;
            const response = await axios.get(`${API_BASE}${status ? '?status=' + status : ''}`);
            const tbody = document.getElementById('shipmentTableBody');
            tbody.innerHTML = '';

            if (response.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data</td></tr>';
                return;
            }

            response.data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.order_id}</td>
                    <td>${item.shipping_address}</td>
                    <td>${item.shipping_service}</td>
                    <td>${item.weight}</td>
                    <td>${item.status}</td>
                    <td>
                        ${item.status === 'pending' ? `<button class='btn btn-success btn-sm' onclick='ship(${item.id})'>Kirim</button>` : ''}
                        ${item.status === 'shipped' ? `<button class='btn btn-info btn-sm' onclick='deliver(${item.id})'>Selesaikan</button>` : ''}
                        <button class='btn btn-secondary btn-sm' onclick='printReceipt(${item.id})'>Struk</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function ship(id) {
            await axios.post(`${API_BASE}/${id}/ship`);
            fetchShipments();
        }

        async function deliver(id) {
            await axios.post(`${API_BASE}/${id}/deliver`);
            fetchShipments();
        }

        async function printReceipt(id) {
            const response = await axios.get(`${API_BASE}/${id}/receipt`);
            const receipt = response.data;
            alert(`Struk Pengiriman:\n\nTracking: ${receipt.tracking_number}\nAlamat: ${receipt.shipping_address}\nBerat: ${receipt.weight} kg\nStatus: ${receipt.status}`);
        }

        async function submitShipment(e) {
            e.preventDefault();
            const data = {
                qc_id: document.getElementById('qc_id').value,
                order_id: document.getElementById('order_id').value,
                shipping_address: document.getElementById('shipping_address').value,
                shipping_service: document.getElementById('shipping_service').value,
                weight: document.getElementById('weight').value
            };
            try {
                await axios.post(API_BASE, data);
                alert('Pengiriman berhasil dibuat!');
                fetchShipments();
            } catch (err) {
                alert('Gagal membuat pengiriman: ' + err.response?.data?.error || err.message);
            }
        }

        // Initial fetch
        fetchShipments();
    </script>
</body>
</html>