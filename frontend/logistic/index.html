{% extends "/layouts/staff-layout.html" %}

{% block title %}Logistic Management{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Logistic Management</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item active">Logistic</li>
    </ol>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter me-1"></i>
            Filter Shipments
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary" onclick="filterShipments()">Apply Filter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shipments Table -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Shipments List
        </div>
        <div class="card-body">
            <table id="shipmentsTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Order ID</th>
                        <th>QC ID</th>
                        <th>Status</th>
                        <th>Shipping Address</th>
                        <th>Shipping Service</th>
                        <th>Weight (kg)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="shipmentsTableBody">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create Shipment Modal -->
    <div class="modal fade" id="createShipmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Shipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createShipmentForm">
                        <div class="mb-3">
                            <label class="form-label">QC ID</label>
                            <input type="number" class="form-control" name="qc_id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Order ID</label>
                            <input type="number" class="form-control" name="order_id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Shipping Address</label>
                            <textarea class="form-control" name="shipping_address" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Shipping Service</label>
                            <select class="form-select" name="shipping_service" required>
                                <option value="JNE">JNE</option>
                                <option value="SiCepat">SiCepat</option>
                                <option value="J&T">J&T</option>
                                <option value="GoSend">GoSend</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Weight (kg)</label>
                            <input type="number" step="0.01" class="form-control" name="weight" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="createShipment()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shipping Receipt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="receiptContent">
                    <!-- Receipt content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printReceipt()">Print</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fetch and display shipments
    function loadShipments(status = '') {
        const url = status ? `/api/shipments?status=${status}` : '/api/shipments';
        fetch(url, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('shipmentsTableBody');
            tbody.innerHTML = '';
            
            data.forEach(shipment => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${shipment.id}</td>
                    <td>${shipment.order_id}</td>
                    <td>${shipment.qc_id}</td>
                    <td><span class="badge bg-${getStatusBadgeColor(shipment.status)}">${shipment.status}</span></td>
                    <td>${shipment.shipping_address}</td>
                    <td>${shipment.shipping_service}</td>
                    <td>${shipment.weight}</td>
                    <td>
                        ${getActionButtons(shipment)}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => console.error('Error:', error));
    }

    // Filter shipments
    function filterShipments() {
        const status = document.getElementById('statusFilter').value;
        loadShipments(status);
    }

    // Create new shipment
    function createShipment() {
        const form = document.getElementById('createShipmentForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        fetch('/api/shipments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                $('#createShipmentModal').modal('hide');
                loadShipments();
                form.reset();
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Ship order
    function shipOrder(id) {
        fetch(`/api/shipments/${id}/ship`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                loadShipments();
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Mark as delivered
    function markAsDelivered(id) {
        fetch(`/api/shipments/${id}/deliver`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                loadShipments();
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Get receipt
    function getReceipt(id) {
        fetch(`/api/shipments/${id}/receipt`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                displayReceipt(data);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Display receipt in modal
    function displayReceipt(data) {
        const receiptContent = document.getElementById('receiptContent');
        receiptContent.innerHTML = `
            <div class="receipt">
                <h4 class="text-center mb-4">Shipping Receipt</h4>
                <div class="row mb-3">
                    <div class="col-6">
                        <p><strong>Shipping Date:</strong> ${data.shipping_date || 'Not shipped yet'}</p>
                        <p><strong>Status:</strong> ${data.status}</p>
                        <p><strong>Shipping Service:</strong> ${data.shipping_service}</p>
                    </div>
                    <div class="col-6">
                        <p><strong>Weight:</strong> ${data.weight} kg</p>
                        <p><strong>Shipping Address:</strong> ${data.shipping_address}</p>
                    </div>
                </div>
                <div class="order-details mt-4">
                    <h5>Order Details</h5>
                    <pre>${JSON.stringify(data.order_details, null, 2)}</pre>
                </div>
            </div>
        `;
        $('#receiptModal').modal('show');
    }

    // Print receipt
    function printReceipt() {
        const receiptContent = document.getElementById('receiptContent').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Shipping Receipt</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                </head>
                <body>
                    ${receiptContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() {
                                window.close();
                            };
                        };
                    </script>
                </body>
            </html>
        `);
    }

    // Helper functions
    function getStatusBadgeColor(status) {
        switch (status) {
            case 'pending': return 'warning';
            case 'shipped': return 'info';
            case 'delivered': return 'success';
            default: return 'secondary';
        }
    }

    function getActionButtons(shipment) {
        let buttons = '';

        if (shipment.status === 'pending') {
            buttons += `<button class="btn btn-sm btn-primary me-1" onclick="shipOrder(${shipment.id})">Ship</button>`;
        }
        if (shipment.status === 'shipped') {
            buttons += `<button class="btn btn-sm btn-success me-1" onclick="markAsDelivered(${shipment.id})">Deliver</button>`;
        }

        buttons += `<button class="btn btn-sm btn-secondary" onclick="getReceipt(${shipment.id})">Receipt</button>`;
        return buttons;
    }

    // Load shipments on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadShipments();
    });
</script>
{% endblock %}